# Избыточность в распределенных системах

Избыточность — это не просто наличие резервного сервера, это систематическое устранение единичных точек отказа на всех уровнях вашего стека. Задача архитекторов SaaS состоит в том, чтобы сбалансировать стоимость и сложность избыточности с бизнес-требованиями, сохранив при этом работоспособность системы.

## Географическая избыточность

Географическая избыточность — это наиболее заметная форма отказоустойчивости инфраструктуры. Когда пользователи в Токио получают доступ к вашему сервису, они не должны зависеть от серверов в Вирджинии, и не только из соображений производительности, но и для обеспечения отказоустойчивости.

**Многорегиональная архитектура** распределяет весь стек приложений по географически удаленным дата-центрам. Например, регионы AWS спроектированы таким образом, чтобы быть изолированными друг от друга в случае сбоев — когда в регионе US-East-1 возникают проблемы, регион US-West-2 продолжает работать независимо. Эта изоляция распространяется не только на серверное оборудование, но и на отдельные сети электропитания, сетевых провайдеров и даже отдельные операционные команды.

Сложность реализации заключается в обеспечении согласованности данных и синхронизации состояний между регионами. Например, Stripe поддерживает отдельные кластеры баз данных в каждом регионе, но использует асинхронную репликацию и тщательное разделение данных, чтобы обеспечить продолжение обработки платежей даже в случае сбоя всего региона.

**Развертывание в нескольких зонах доступности** представляет собой компромисс между простотой одной зоны и сложностью нескольких регионов. В пределах одного региона зоны доступности представляют собой физически раздельные центры обработки данных с независимым питанием и сетью, но с высокоскоростными соединениями с низкой задержкой между ними. Такая конфигурация обеспечивает отказоустойчивость на уровне объекта и сохраняет высокую согласованность баз данных.

Кластеры Kubernetes обычно автоматически охватывают несколько зон доступности при правильной настройке. Ваши поды распределяются по зонам, и если одна зона выходит из строя, остальные зоны обрабатывают нагрузку. Компромисс заключается в том, что межзональный трафик влечет за собой некоторую задержку и дополнительные затраты, но преимущества от отказоустойчивости обычно оправдывают эти затраты.

## Проектирование безсостоятельных сервисов

Проектирование безсостоятельных сервисов лежит в основе многих моделей избыточности приложений. Когда сервисы не хранят локальное состояние, любой экземпляр может обработать любой запрос, что упрощает горизонтальное масштабирование и восстановление после сбоев. **Балансировщик нагрузки** может направлять запросы на любой рабочий экземпляр, а неработающие экземпляры можно заменить без потери данных. Современные приложения SaaS достигают безсостоятельности за счет выноса данных сеанса в Redis или базы данных, использования токенов JWT для аутентификации и проектирования API с идемпотентностью. Такой подход обеспечивает эластичное масштабирование, которое делает облачные технологии экономически выгодными: вы можете добавлять экземпляры во время пиковых нагрузок и удалять их в периоды затишья, не беспокоясь о сохранении состояния.

## Отказоустойчивость

Механизмы отказоустойчивости автоматически перенаправляют трафик с неисправных компонентов на исправные, сводя к минимуму перебои в работе сервиса. Ключевым моментом является реализация отказоустойчивости, которая будет достаточно быстрой, чтобы не ухудшить пользовательский опыт, и достаточно надежной, чтобы избежать ложных срабатываний, вызывающих ненужные перебои в работе сервиса.

**Активно-пассивная отказоустойчивость** поддерживает резервный экземпляр, который принимает на себя работу при сбое основного. Этот подход широко используется в базах данных, где копия для чтения может быть переведена в основной статус за считанные секунды. Развертывания AWS RDS Multi-AZ являются примером этого шаблона — резервный экземпляр работает в другой зоне доступности и автоматически становится основным при сбоях, обычно завершая отработку отказа в течение 60–120 секунд.

**Активно-активная отработка отказа** распределяет трафик между несколькими экземплярами непрерывно, поэтому сбой одного экземпляра просто означает, что другие обрабатывают более высокую нагрузку. Этот подход требует тщательной балансировки нагрузки и управления сессиями, но обеспечивает более быстрое восстановление, поскольку не требуется процесс повышения статуса. Сети доставки контента, такие как CloudFlare, используют эту модель в своих глобальных пограничных точках.

**Прерыватели** дополняют традиционную отработку отказа, предотвращая каскадные сбои. Когда нижестоящий сервис выходит из строя, прерыватели прекращают отправку запросов к нему, давая время на восстановление и предоставляя пользователям резервные ответы. Библиотеки, такие как Hystrix (Java) или go-resilience (Go), реализуют сложную логику автоматического отключения с настраиваемыми порогами сбоев и стратегиями восстановления.

### Избыточность хранения

Избыточность хранения обеспечивает доступность данных с помощью нескольких механизмов хранения. Помимо репликации баз данных, распределенных файловых систем и облачного хранения со встроенной избыточностью, например, репликация нескольких центров обработки данных S3 в пределах одного региона.
**Один мастер с репликами для чтения** обеспечивает баланс между простотой и масштабируемостью. Потоковая репликация PostgreSQL является примером этого: один основной сервер обрабатывает записи, а реплики для чтения обслуживают запросы в зонах доступности. В случае сбоя основного сервера инструменты, такие как Patroni, автоматически продвигают реплику в течение нескольких секунд. Приложения должны обрабатывать маршрутизацию чтения/записи и конечную согласованность, но ORM, такие как Django, абстрагируют большую часть этой сложности.

**Репликация без мастера** устраняет единичные точки отказа, рассматривая все узлы как равные. Cassandra и DynamoDB используют этот подход — записи поступают на несколько узлов одновременно в соответствии с требованиями к согласованности (записи кворума обеспечивают долговечность). Любой узел может выйти из строя без ущерба для доступности, а система самовосстанавливается с помощью антиэнтропийных процессов. Приложения получают преимущества от упрощенных операций, но должны обрабатывать конечную согласованность и потенциальные конфликты во время сетевых разделений.

**Базы данных с несколькими мастерами** позволяют записывать данные одновременно в несколько экземпляров базы данных, обеспечивая как масштабируемость, так и избыточность. Системы, такие как CockroachDB и YugabyteDB, используют распределенный консенсус для поддержания согласованности между несколькими мастер-узлами, устраняя единичные точки отказа на уровне базы данных.
Сложность подходов с несколькими мастерами заключается в разрешении конфликтов и поддержании согласованности между географически распределенными мастерами. CockroachDB решает эту проблему с помощью распределенных транзакций со строгой сериализуемой изоляцией, принимая затраты на задержку, связанные с глобальным консенсусом.
**Прокси-слои баз данных** обеспечивают избыточность на уровне соединений. Такие инструменты, как ProxySQL для MySQL или PgBouncer для PostgreSQL, могут автоматически направлять запросы на исправные экземпляры баз данных, обрабатывать пул соединений и обеспечивать прозрачную отработку отказа для приложений.

**Межоблачная избыточность данных** обеспечивает максимальную защиту от сбоев облачных провайдеров. Такие компании, как Snowflake и MongoDB Atlas, предлагают мультиоблачные развертывания, при которых ваши данные одновременно хранятся в AWS, Google Cloud и Azure. Такой подход защищает не только от технических сбоев, но и от бизнес-рисков, таких как изменение цен или прекращение предоставления услуг.

## Вывод

Избыточность — это не функция, которую добавляют в конце, а архитектурная философия, которая влияет на каждое проектное решение. Наиболее надежные системы SaaS разрабатываются с нуля с учетом возможных сбоев и продолжения работы независимо от них.

Начните с простого, измерьте фактические режимы сбоев и инвестируйте в избыточность там, где она обеспечивает наибольшую отдачу в плане надежности. Системы, которые определят следующее десятилетие, будут не теми, которые никогда не выходят из строя, а теми, которые выходят из строя с минимальными потерями и быстро восстанавливаются.
