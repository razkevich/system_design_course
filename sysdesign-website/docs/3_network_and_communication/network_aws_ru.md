# Архитектура облачных сетей AWS

Облачные сети составляют основу инфраструктуры распределенных систем, обеспечивая связь и взаимодействие между службами, приложениями и пользователями. Понимание основ облачных сетей необходимо для устранения проблем в производственной среде, проектирования масштабируемых архитектур и принятия обоснованных технических решений.

В этом разделе рассматриваются сетевые службы AWS и архитектурные шаблоны в качестве комплексного примера принципов работы облачных сетей.
## Иерархия инфраструктуры AWS

**Учетная запись AWS** служит контейнером высшего уровня в AWS, охватывающим все ресурсы и службы в рамках единой системы биллинга и администрирования. Представьте ее как выделенное пространство вашей организации в облаке AWS, где вы можете предоставлять вычислительные инстансы, хранилища, сетевые компоненты и другие службы. Учетная запись управляет биллингом, контролем доступа, мониторингом использования и политиками безопасности для всех ресурсов в ее пределах. Этот централизованный подход позволяет организациям сохранять четкий контроль над своей облачной инфраструктурой и обеспечивать единое управление всеми службами AWS.

Клиенты AWS часто создают несколько учетных записей по нескольким стратегическим причинам:
* **Разделение приложений** — разные приложения могут иметь разные требования к безопасности, нормативные требования или операционные команды, что делает изоляцию на уровне учетной записи выгодной.
* **Разделение арендаторов** — многопользовательские приложения могут требовать строгой изоляции данных между клиентами, что естественным образом обеспечивается границами учетных записей.
* **Изоляция сред** — отдельные учетные записи для сред разработки, тестирования и производства предотвращают случайное влияние между средами.
* **Распределение затрат** — отдельные учетные записи позволяют точно отслеживать затраты и выставлять счета для разных подразделений или проектов.
* **Требования к соответствию** — некоторые нормативные требования предписывают строгое разделение данных и систем, чему способствуют границы учетных записей.

Настройка нескольких учетных записей обеспечивает четкое разделение ресурсов и гарантирует, что участники одной учетной записи не смогут повлиять на другие учетные записи.

**Регионы AWS** — это следующий уровень разделения внутри учетных записей. Большинство ресурсов AWS являются региональными, включая экземпляры EC2, базы данных RDS, VPC и корзины S3, в то время как некоторые службы, такие как пользователи IAM, Route 53 и CloudFront, работают глобально во всех регионах. Регион представляет собой место, где физически расположены серверы и центры обработки данных. Например, регион Северная Вирджиния в США называется _us-east-1_. Таким образом, клиенты должны выбрать физическое место для размещения своих служб. Выбор региона влияет на несколько важных факторов, включая производительность, соблюдение законодательных требований (GDPR требует, чтобы данные граждан ЕС оставались в пределах ЕС), различия в стоимости между регионами, доступность услуг и возможности восстановления после сбоев. Организации также могут создавать многорегиональные архитектуры для повышения доступности и глобального охвата.

**Зоны доступности AWS (AZ)** — это изолированные центры обработки данных в пределах региона, обычно от 2 до 6 на регион, соединенные между собой высокоскоростными сетями с низкой задержкой. Они обеспечивают высокую доступность, позволяя приложениям охватывать несколько физических местоположений при сохранении быстрой взаимосвязи.

**Локальные зоны** приближают инфраструктуру AWS к конечным пользователям в мегаполисах, обеспечивая задержку в миллисекундах для приложений, требующих реагирования в реальном времени, таких как игры или приложения AR/VR.

**Пограничные зоны** — это точки присутствия глобальной сети доставки контента (CDN) AWS, которых насчитывается сотни по всему миру. Они кэшируют контент вблизи пользователей для таких сервисов, как CloudFront и Route 53, что значительно сокращает задержки при доставке статического контента.

## Сетевые сервисы AWS

### Виртуальная частная облачная сеть (VPC)

AWS VPC предоставляет изолированную сетевую среду в AWS, аналогичную традиционному центру обработки данных, но виртуализированную в облаке. Ресурсы в VPC обмениваются данными с использованием частных IP-адресов, будучи логически отделенными от ресурсов других клиентов. Каждая учетная запись AWS включает одну VPC по умолчанию для каждого региона с возможностью создания до 5 дополнительных VPC для каждого региона (с возможностью расширения с помощью службы поддержки AWS).


Каждой VPC назначается **блок CIDR** (Classless Inter-Domain Routing), который определяет диапазон IP-адресов, доступных в этой VPC. Например, блок CIDR `10.0.0.0/16` предоставляет 65 536 IP-адресов (от 10.0.0.0 до 10.0.255.255). При создании VPC необходимо указать этот блок CIDR, и все подсети в пределах VPC будут использовать части этого адресного пространства. Важно тщательно планировать блоки CIDR, чтобы избежать конфликтов с другими сетями, к которым вам может понадобиться подключиться в будущем.

Ключевые свойства AWS VPC включают:
* **Изолированная сетевая среда** — полное логическое отделение от других клиентов AWS и даже других VPC в вашей учетной записи
* **Частное пространство IP-адресов** — ресурсы обмениваются данными с использованием частных диапазонов IP-адресов RFC 1918 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
* **Настраиваемая топология сети** — полный контроль над подсетями, таблицами маршрутизации, шлюзами и группами безопасности
* **Поддержка нескольких зон доступности** — подсети могут охватывать разные зоны доступности для обеспечения высокой доступности
* **Масштабируемая архитектура** — может вместить тысячи ресурсов в нескольких подсетях

### Подсети

Подсети — это подразделения VPC, которые позволяют группировать ресурсы и применять к ним разные сетевые правила. Каждая подсеть существует в пределах одной зоны доступности и использует часть блока CIDR VPC. Организации создают несколько подсетей по нескольким причинам:

* **Высокая доступность** — распределение ресурсов по подсетям в разных зонах доступности обеспечивает избыточность
* **Сегментация безопасности** — отделение общедоступных веб-серверов от частных баз данных
* **Контроль доступа** — общедоступные подсети имеют доступ к Интернету через шлюз Интернета, а частные подсети остаются изолированными
* **Требования к соответствию** — для разных уровней могут потребоваться разные средства контроля безопасности

По умолчанию каждая VPC содержит одну подсеть на каждую зону доступности в регионе.

## Подключение к Интернету

### Таблицы маршрутизации, группы безопасности и NACL

![Иерархия сетей AWS](/img/aws_networking_hierarchy.svg)

Таблицы маршрутизации назначаются подсетям и определяют правила маршрутизации, которые определяют, куда направляется сетевой трафик. Каждая таблица маршрутизации содержит набор правил (маршрутов), которые определяют сеть назначения и цель (шлюз, сетевой интерфейс или соединение) для достижения этого назначения. Таблицы маршрутизации контролируют поток трафика, но не фильтруют и не блокируют трафик — они просто направляют его в соответствующее место назначения. Каждая подсеть должна быть связана только с одной таблицей маршрутизации, хотя несколько подсетей могут использовать одну и ту же таблицу маршрутизации.

Пример таблицы маршрутизации:

| Пункт назначения | Цель |
| ----------- | ------ |
| VPC CIDR | Локальный |
| 0.0.0.0/0 | igw-1 |

Группа безопасности создается на уровне VPC и контролирует доступ на уровне ресурсов (например, экземпляра EC2). Она контролирует трафик на основе протоколов, портов и IP-адресов. Вы определяете правила входящего и исходящего трафика для группы безопасности. Группы безопасности являются состоятельными (вы можете получить ответ от ресурса AWS без дополнительной настройки). Каждая VPC имеет группу безопасности по умолчанию (не может быть удалена), и можно создать дополнительные группы.

Пример группы безопасности:

| Тип | Протокол | Диапазон портов | Пункт назначения | Описание |
| ---- | -------- | ---------- | ------------- | ------------- |
| SSH | TCP | 22 | 117.212.92.68 | Некоторое правило SSH |

**Списки контроля доступа к сети (NACL)** работают на уровне подсети и обеспечивают дополнительный уровень безопасности помимо групп безопасности. В отличие от групп безопасности, которые контролируют трафик на уровне экземпляра, NACL фильтруют трафик при его входе в подсеть или выходе из нее. NACL не имеют состояния, что означает, что обратный трафик должен быть явно разрешен как входящими, так и исходящими правилами. Они служат в качестве брандмауэра на уровне подсети и часто используются для реализации стратегий глубокой защиты. Каждая VPC поставляется с NACL по умолчанию, который разрешает весь трафик, и каждая подсеть должна быть связана только с одним NACL.

Пример NACL:


| Номер правила | Тип | Протокол | Диапазон портов | Источник | Разрешить/запретить |
| ----------- | ----------- | -------- | ---------- | --------- | ---------- |
| 123 | Весь трафик | Все | Все | 0.0.0.0/0 | Разрешить |
| * | Весь трафик | Все | Все | 0.0.0.0/0 | Запретить |
### Взаимодействие: таблицы маршрутизации, группы безопасности и NACL

Эти три сетевых компонента работают в нескольких уровнях, обеспечивая комплексный контроль трафика:

1. **Таблицы маршрутов** определяют, куда направляется трафик — они похожи на дорожные знаки, направляющие транспорт к месту назначения.
2. **NACL** действуют как первый контрольно-пропускной пункт на границах подсетей — как ограждение вокруг здания.
3. **Группы безопасности** обеспечивают последний уровень безопасности отдельных ресурсов — как замки на дверях конкретных комнат.

Этот многоуровневый подход обеспечивает как широкую маршрутизацию сети, так и тонкий контроль безопасности. Например, таблица маршрутов может направлять веб-трафик в публичную подсеть, NACL может блокировать подозрительные диапазоны IP-адресов на уровне подсети, а группы безопасности могут ограничивать доступ к базе данных только определенными серверами приложений. Эта стратегия глубокой защиты обеспечивает надежную безопасность сети и правильный поток трафика.

### Подключение VPC к Интернету

#### Интернет-шлюз

Интернет-шлюз (IGW) служит мостом между VPC и публичным Интернетом, позволяя ресурсам в публичных подсетях обмениваться данными с Интернетом, сохраняя при этом безопасность с помощью таблиц маршрутизации и групп безопасности.

Ключевые характеристики:
* **Двунаправленная связь** — поддержка входящего и исходящего интернет-трафика
* **Один на VPC** — к каждой VPC может быть подключен только один шлюз Интернета
* **Требование к публичному IP-адресу** — для связи через IGW ресурсам требуется либо эластичный IP-адрес, либо публичный IP-адрес
* **Интеграция таблицы маршрутизации** — для доступа в Интернет требуются явные маршруты (0.0.0.0/0 → IGW) в таблицах маршрутизации подсетей

#### NAT Gateway

Шлюз NAT (Network Address Translation) позволяет ресурсам в частных подсетях получать доступ к Интернету для исходящих подключений, предотвращая при этом попадание входящего интернет-трафика в эти подсети. Это необходимо для частных ресурсов, которым требуется загружать обновления, получать доступ к API или взаимодействовать с внешними службами.

Основные характеристики:
* **Только исходящая связь** — позволяет частным ресурсам инициировать подключения к Интернету, но блокирует входящие подключения
* **Высокая доступность** — управляемый AWS сервис с автоматической отработкой отказа в пределах зоны доступности
* **Требуется эластичный IP-адрес** — должен быть связан с эластичным IP-адресом для подключения к Интернету
* **Маршрутизация частных подсетей** — таблицы маршрутизации в частных подсетях указывают на шлюз NAT для трафика, направляемого в Интернет (0.0.0.0/0 → шлюз NAT)

![Маршрутизация в Интернете](/img/internet_routing.svg)

*На этой схеме показано, как шлюз Интернета обеспечивает двунаправленную связь для публичных подсетей, а шлюз NAT — безопасный исходящий доступ в Интернет для частных подсетей.*

### Связь между VPC

AWS предоставляет несколько методов подключения VPC, каждый из которых предназначен для различных сценариев использования и требований к масштабируемости:

#### Пиринг VPC
VPC Peering создает прямое частное сетевое соединение между двумя VPC, позволяя ресурсам обмениваться данными, как если бы они находились в одной сети. Это работает в пределах одного региона или между регионами, обеспечивая простое соединение «точка-точка». Однако соединения пиринга не поддерживают транзитивную маршрутизацию — если VPC A пирингуется с VPC B, а VPC B пирингуется с VPC C, VPC A не может автоматически достичь VPC C.

#### AWS Transit Gateway
Transit Gateway действует как сетевой концентратор, упрощая подключение между несколькими VPC, локальными сетями и службами AWS. Вместо создания отдельных пиринговых подключений между каждой парой VPC, все сети подключаются к Transit Gateway, который обрабатывает маршрутизацию между ними. Эта модель «звездочки» значительно снижает сложность и поддерживает транзитивную маршрутизацию, что делает ее идеальной для крупномасштабных сетевых архитектур.

#### AWS PrivateLink
PrivateLink обеспечивает частное соединение между VPC и службами AWS или сторонними службами без прохождения через общедоступный Интернет. Он создает конечные точки VPC, которые обеспечивают безопасный доступ к таким службам, как S3, DynamoDB или приложениям SaaS. Трафик проходит через частную сеть AWS, что обеспечивает высокую безопасность и производительность, а также устраняет зависимость от интернет-шлюзов.
#### VPC Lattice
VPC Lattice — это новая услуга, которая обеспечивает сетевое взаимодействие на уровне приложений, позволяя безопасно обмениваться данными между службами в разных VPC и учетных записях. Она работает на уровне приложений, а не на уровне сети, предлагая такие функции, как обнаружение служб, балансировка нагрузки и контроль доступа. Lattice упрощает взаимодействие между службами в микросервисных архитектурах, охватывающих несколько VPC.

![Методы подключения VPC](/img/vpc_connectivity.svg)
### VPN-подключение

AWS предоставляет VPN-решения для безопасного подключения внешних сетей и устройств к вашей VPC через Интернет. Эти зашифрованные подключения расширяют инфраструктуру вашей частной сети в облако.

#### VPN «сайт-сайт»
VPN «сайт-сайт» соединяет целые сети, такие как корпоративный центр обработки данных, с VPC AWS. Это позволяет создавать гибридные облачные архитектуры, в которых локальные системы могут безопасно обмениваться данными с облачными ресурсами. Например, компания может хранить устаревшие серверы баз данных в своем центре обработки данных, а новые приложения запускать в AWS, при этом VPN «сайт-сайт» обеспечивает бесперебойную связь между обеими средами.

#### Клиентская VPN
Клиентская VPN позволяет отдельным устройствам безопасно подключаться к ресурсам VPC. Удаленные сотрудники могут получать доступ к частным приложениям, базам данных или средам разработки, размещенным в AWS, как если бы они физически находились в офисе. Это особенно ценно для доступа к внутренним инструментам, базам данных или приложениям, которые не должны быть доступны в общедоступном Интернете.

Оба типа VPN используют шифрование IPsec для обеспечения безопасности данных во время передачи и интегрируются с средствами маршрутизации и контроля безопасности AWS, поддерживая тот же уровень безопасности, что и внутренний трафик VPC.

![VPN-подключение](/img/vpn_connectivity.svg)

## Глобальные службы: Route 53 и CloudFront

Эти глобальные службы AWS оптимизируют доставку контента и разрешение доменных имен для повышения производительности приложений и удобства работы пользователей.

**Amazon Route 53** — это масштабируемый DNS-сервис AWS, который преобразует доменные имена в IP-адреса. Помимо базовых функций DNS, Route 53 предоставляет интеллектуальные политики маршрутизации, такие как геолокационная маршрутизация (направление пользователей на ближайший сервер), взвешенная маршрутизация (распределение трафика между несколькими конечными точками) и проверки работоспособности с автоматическим переключением при сбое. Он легко интегрируется с другими сервисами AWS и поддерживает как публичные домены, так и частные DNS для ресурсов VPC.

**Amazon CloudFront** — это сеть доставки контента (CDN) AWS, которая кэширует контент в пограничных точках по всему миру. Она сокращает задержки, обслуживая статический контент (изображения, видео, CSS-файлы) из точек, ближайших к пользователям, а не с исходных серверов. CloudFront также ускоряет динамический контент за счет оптимизированных сетевых путей и поддерживает такие функции, как SSL-терминация, настраиваемые страницы ошибок и метрики в реальном времени. Он особенно хорошо работает с S3 для статических веб-сайтов и с Route 53 для управления глобальным трафиком.

## Сетевые компоненты

AWS предоставляет несколько управляемых сетевых компонентов, которые обрабатывают распределение трафика, управление API и подключение приложений:

### AWS Elastic Load Balancer (ELB)

Elastic Load Balancer распределяет входящий трафик между несколькими целями, чтобы обеспечить высокую доступность и отказоустойчивость. AWS предлагает три типа:

* **Application Load Balancer (ALB)** — работает на уровне 7 (HTTP/HTTPS) и обеспечивает расширенную маршрутизацию на основе контента, заголовков хоста или шаблонов путей. Идеально подходит для микросервисов и контейнерных приложений.
* **Network Load Balancer (NLB)** — работает на уровне 4 (TCP/UDP) и обрабатывает миллионы запросов в секунду с ультранизкой задержкой. Идеально подходит для высокопроизводительных приложений, требующих статических IP-адресов.
* **Gateway Load Balancer (GWLB)** — работает на уровне 3 и предназначен для развертывания виртуальных устройств сторонних производителей, таких как брандмауэры и системы обнаружения вторжений.
### Amazon API Gateway

API Gateway — это полностью управляемый сервис для создания, публикации и управления API в больших масштабах. Он обрабатывает версии API, аутентификацию, ограничение скорости и преобразование запросов/ответов. API Gateway интегрируется с Lambda для бессерверных архитектур и обеспечивает мониторинг через CloudWatch. Он поддерживает REST API, WebSocket API и HTTP API с различными наборами функций и моделями ценообразования.

### Другие сетевые компоненты

* **AWS Global Accelerator** — улучшает производительность приложений за счет маршрутизации трафика через глобальную сетевую инфраструктуру AWS
* **AWS App Mesh** — service mesh, которая обеспечивает сетевое взаимодействие на уровне приложений для коммуникации микросервисов
* **AWS Cloud Map** — обнаружение сервисов для облачных приложений, позволяющее сервисам находить друг друга и взаимодействовать
* **Elastic Network Interfaces (ENI)** — виртуальные сетевые интерфейсы, которые можно подключать к экземплярам EC2 для дополнительных сетевых возможностей

## Резюме

Сетевые возможности AWS предоставляют комплексную основу для построения масштабируемых и безопасных облачных архитектур. Иерархическая структура — от учетных записей и регионов до подсетей и отдельных ресурсов — обеспечивает точный контроль над топологией и безопасностью сети.

Ключевые выводы для инженеров:

**Основная инфраструктура**: VPC создают изолированные сетевые среды с настраиваемыми пространствами IP-адресов и доступностью в нескольких зонах доступности. Подсети обеспечивают логическую сегментацию для безопасности и высокой доступности.

**Уровни безопасности**: трехуровневая модель безопасности обеспечивает глубокую защиту — таблицы маршрутизации направляют поток трафика, NACL фильтруют на границах подсетей, а группы безопасности контролируют доступ к отдельным ресурсам.

**Подключение к Интернету**: интернет-шлюзы обеспечивают двунаправленный публичный доступ, а NAT-шлюзы — безопасное подключение только для исходящего трафика для частных ресурсов.

**Межсетевое взаимодействие VPC**: несколько вариантов подключения (пиринг, Transit Gateway, PrivateLink, VPC Lattice) поддерживают различные архитектурные модели, от простых соединений «точка-точка» до сложных service mesh.

**Гибридная интеграция**: VPN «сайт-сайт» и «клиент» расширяют локальные сети в облако, обеспечивая бесшовные гибридные архитектуры и удаленный доступ.

**Глобальные службы**: Route 53 и CloudFront оптимизируют производительность за счет интеллектуальной маршрутизации DNS и глобального кэширования контента.

Понимание этих основ сетей позволяет инженерам устранять проблемы в производственной среде, проектировать отказоустойчивые системы и принимать обоснованные архитектурные решения. Будь то отладка проблем межсервисной связи или проектирование многоуровневых приложений, эти знания в области сетей оказываются неоценимыми для эффективного проектирования облачных систем.